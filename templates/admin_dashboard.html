{% extends "base.html" %}

{% block title %}Admin Dashboard - Student ID System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">
            <i class="fas fa-tachometer-alt me-2 text-primary"></i> Admin Dashboard
            <span class="admin-badge">Admin View</span>
        </h2>
        <p class="text-muted">Manage and monitor student ID applications</p>
    </div>
    <div>
        <button class="btn btn-primary shadow-sm" id="refresh-data">
            <i class="fas fa-sync-alt me-2"></i> Refresh
        </button>
    </div>
</div>

<!-- Status Cards Row -->
<div class="row g-4 mb-4">
    <!-- Total Applications -->
    <div class="col-md-3">
        <div class="card status-card h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="status-icon text-primary mb-3">
                    <i class="fas fa-users fa-3x"></i>
                </div>
                <div class="status-count" id="total-students">{{ total_students }}</div>
                <div class="status-label">Total Students</div>
            </div>
        </div>
    </div>

    <!-- Pending Applications -->
    <div class="col-md-3">
        <div class="card status-card pending h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="status-icon text-warning mb-3">
                    <i class="fas fa-hourglass-half fa-3x"></i>
                </div>
                <div class="status-count" id="pending-count">{{ pending }}</div>
                <div class="status-label">Pending</div>
            </div>
        </div>
    </div>

    <!-- Processing Applications -->
    <div class="col-md-3">
        <div class="card status-card processing h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="status-icon text-info mb-3">
                    <i class="fas fa-cogs fa-3x"></i>
                </div>
                <div class="status-count" id="processing-count">{{ processing }}</div>
                <div class="status-label">Processing</div>
            </div>
        </div>
    </div>

    <!-- Completed Applications -->
    <div class="col-md-3">
        <div class="card status-card done h-100 border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <div class="status-icon text-success mb-3">
                    <i class="fas fa-check-circle fa-3x"></i>
                </div>
                <div class="status-count" id="done-count">{{ done }}</div>
                <div class="status-label">Completed</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts & Recent Applications -->
<div class="row">
    <!-- Application Status Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i> Application Status
                </h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center p-4">
                <div style="position: relative; height: 280px; width: 100%;">
                    <canvas id="applicationStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Applications -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-clipboard-list me-2"></i> Recent Applications
                </h5>
                <a href="{{ url_for('admin_applications') }}" class="btn btn-sm btn-primary rounded-pill px-3">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 modern-table">
                        <thead class="table-dark">
                            <tr>
                                <th class="ps-4">Student ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="recent-applications">
                            <!-- Will be populated with real data -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-primary text-white">
                <h5 class="modal-title" id="studentDetailsModalLabel">
                    <i class="fas fa-user me-2"></i> Student Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-4 mb-4 mb-md-0">
                        <div class="text-center">
                            <div class="position-relative mb-3 mx-auto" style="width: 150px; height: 150px;">
                                <img src="/placeholder.svg" class="img-preview rounded-circle object-fit-cover w-100 h-100 border shadow-sm" id="modal-profile-picture" alt="Student Profile">
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <div class="position-relative mb-3 mx-auto" style="max-width: 200px;">
                                <img src="/placeholder.svg" class="img-preview img-fluid rounded shadow-sm" id="modal-signature" alt="Student Signature">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="student-detail-row">
                            <div class="row">
                                <div class="col-md-4 detail-label">Student ID:</div>
                                <div class="col-md-8 fw-bold" id="modal-student-id"></div>
                            </div>
                        </div>
                        <div class="student-detail-row">
                            <div class="row">
                                <div class="col-md-4 detail-label">Name:</div>
                                <div class="col-md-8" id="modal-name"></div>
                            </div>
                        </div>
                        <div class="student-detail-row">
                            <div class="row">
                                <div class="col-md-4 detail-label">Course:</div>
                                <div class="col-md-8" id="modal-course"></div>
                            </div>
                        </div>
                        <div class="student-detail-row">
                            <div class="row">
                                <div class="col-md-4 detail-label">Contact:</div>
                                <div class="col-md-8" id="modal-contact"></div>
                            </div>
                        </div>
                        <div class="student-detail-row">
                            <div class="row">
                                <div class="col-md-4 detail-label">Guardian:</div>
                                <div class="col-md-8" id="modal-guardian"></div>
                            </div>
                        </div>
                        <div class="student-detail-row">
                            <div class="row">
                                <div class="col-md-4 detail-label">Address:</div>
                                <div class="col-md-8" id="modal-address"></div>
                            </div>
                        </div>
                        <div class="student-detail-row">
                            <div class="row">
                                <div class="col-md-4 detail-label">Application Status:</div>
                                <div class="col-md-8">
                                    <span class="badge" id="modal-status"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="mb-3 fw-bold text-primary">Application Status Timeline</h6>
                    <div class="status-timeline">
                        <div class="timeline-item" id="timeline-pending">
                            <div class="timeline-content">
                                <div class="timeline-title">Application Submitted</div>
                                <div class="timeline-date" id="timeline-pending-date">-</div>
                            </div>
                        </div>
                        <div class="timeline-item" id="timeline-processing">
                            <div class="timeline-content">
                                <div class="timeline-title">Processing</div>
                                <div class="timeline-date" id="timeline-processing-date">-</div>
                            </div>
                        </div>
                        <div class="timeline-item" id="timeline-done">
                            <div class="timeline-content">
                                <div class="timeline-title">Ready for Pickup</div>
                                <div class="timeline-date" id="timeline-done-date">-</div>
                            </div>
                        </div>
                        <div class="timeline-item" id="timeline-receive">
                            <div class="timeline-content">
                                <div class="timeline-title">ID Received</div>
                                <div class="timeline-date" id="timeline-receive-date">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Close</button>
                <div class="dropdown">
                    <button class="btn btn-primary rounded-pill px-4 dropdown-toggle" type="button" id="updateStatusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Update Status
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="updateStatusDropdown">
                        <li><a class="dropdown-item status-update" href="#" data-status="pending">Pending</a></li>
                        <li><a class="dropdown-item status-update" href="#" data-status="processing">Processing</a></li>
                        <li><a class="dropdown-item status-update" href="#" data-status="done">Ready for Pickup</a></li>
                        <li><a class="dropdown-item status-update" href="#" data-status="receive">Received</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DataTables CSS & JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Modern Dashboard Styling */
    .card {
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }
    
    .card-header {
        font-weight: 600;
        border-radius: 12px 12px 0 0 !important;
    }
    
    /* Status Cards */
    .status-card {
        transition: all 0.3s ease;
        height: 100%;
        border-left: 4px solid transparent;
        border-radius: 12px;
        overflow: hidden;
    }

    .status-card.pending {
        border-left-color: #ffc107;
    }

    .status-card.processing {
        border-left-color: #0dcaf0;
    }

    .status-card.done {
        border-left-color: #198754;
    }

    .status-card.receive {
        border-left-color: #0d6efd;
    }

    .status-card .status-icon {
        margin-bottom: 15px;
        opacity: 0.9;
    }

    .status-card .status-count {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        line-height: 1;
    }

    .status-card .status-label {
        font-size: 0.9rem;
        color: #adb5bd;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    /* Admin Badge */
    .admin-badge {
        background-color: #dc3545;
        color: white;
        font-size: 0.8rem;
        padding: 4px 12px;
        border-radius: 20px;
        margin-left: 10px;
        font-weight: 500;
        display: inline-block;
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
    }

    /* Page Header */
    .page-header {
        margin-bottom: 25px;
        border-bottom: 1px solid rgba(52, 58, 64, 0.2);
        padding-bottom: 15px;
    }

    .page-header h2 {
        font-weight: 700;
        color: #212529;
        margin-bottom: 5px;
    }

    /* Status Badges */
    .badge {
        padding: 6px 12px;
        font-weight: 500;
        border-radius: 30px;
        font-size: 0.8rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .badge-pending {
        background-color: #ffc107;
        color: #212529;
    }

    .badge-processing {
        background-color: #0dcaf0;
        color: #212529;
    }

    .badge-done {
        background-color: #198754;
        color: white;
    }

    .badge-receive {
        background-color: #0d6efd;
        color: white;
    }

    /* Action Buttons */
    .action-btn {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 5px;
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
    }

    .action-btn-view {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }

    .action-btn-view:hover {
        background-color: #0d6efd;
        color: white;
    }

    /* Student Details */
    .student-detail-row {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(52, 58, 64, 0.1);
    }

    .student-detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #6c757d;
    }

    /* Image Preview */
    .img-preview {
        transition: transform 0.3s;
    }
    
    .img-preview:hover {
        transform: scale(1.05);
    }

    /* Status Timeline */
    .status-timeline {
        position: relative;
        padding-left: 30px;
        margin-top: 20px;
    }

    .status-timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: rgba(52, 58, 64, 0.2);
    }

    .timeline-item {
        position: relative;
        padding-bottom: 25px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -30px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        z-index: 1;
        transition: all 0.3s;
    }

    .timeline-item.active::before {
        background-color: #0d6efd;
        border-color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
    }

    .timeline-item.completed::before {
        background-color: #198754;
        border-color: #198754;
        box-shadow: 0 0 0 4px rgba(25, 135, 84, 0.2);
    }

    .timeline-content {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
    }
    
    .timeline-item.active .timeline-content,
    .timeline-item.completed .timeline-content {
        background-color: #fff;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .timeline-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #212529;
    }

    .timeline-date {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    /* Modern Table Styling */
    .modern-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .modern-table thead th {
        background-color: #212529;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        padding: 15px;
    }
    
    .modern-table thead th:first-child {
        border-top-left-radius: 8px;
    }
    
    .modern-table thead th:last-child {
        border-top-right-radius: 8px;
    }
    
    .modern-table tbody tr {
        transition: all 0.2s;
    }
    
    .modern-table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
        transform: scale(1.01);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .modern-table td {
        padding: 15px;
        vertical-align: middle;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .status-card .status-count {
            font-size: 2rem;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Application Status Chart with real data
        const statusCtx = document.getElementById('applicationStatusChart').getContext('2d');
        const statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'Processing', 'Done', 'Received'],
                datasets: [{
                    data: [
                        {{ pending }}, 
                        {{ processing }}, 
                        {{ done }}, 
                        {{ receive }}
                    ],
                    backgroundColor: [
                        '#ffc107', // warning
                        '#0dcaf0', // info
                        '#198754', // success
                        '#0d6efd'  // primary
                    ],
                    borderWidth: 0,
                    borderRadius: 5,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#212529',
                        bodyColor: '#212529',
                        borderColor: '#dee2e6',
                        borderWidth: 1,
                        padding: 15,
                        cornerRadius: 8,
                        displayColors: true,
                        boxPadding: 10,
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '70%',
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 2000,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Load recent applications
        loadRecentApplications();

        // Function to load recent applications
        function loadRecentApplications() {
            fetch('/get_all_students')
                .then(response => response.json())
                .then(data => {
                    // Sort by most recent first (assuming there's a date field)
                    // and take only the first 5
                    const recentApplications = data.slice(0, 5);
                    
                    const recentApplicationsHtml = recentApplications.map(student => {
                        let badgeClass = '';
                        let statusText = student.application_status ? 
                            student.application_status.charAt(0).toUpperCase() + student.application_status.slice(1) : 
                            'Unknown';
                        
                        switch(student.application_status) {
                            case 'pending':
                                badgeClass = 'badge-pending';
                                break;
                            case 'processing':
                                badgeClass = 'badge-processing';
                                break;
                            case 'done':
                                badgeClass = 'badge-done';
                                break;
                            case 'receive':
                                badgeClass = 'badge-receive';
                                statusText = 'Received';
                                break;
                            default:
                                badgeClass = 'badge-secondary';
                        }
                        
                        return `
                            <tr>
                                <td class="ps-4">${student.student_id}</td>
                                <td>${student.name}</td>
                                <td><span class="badge ${badgeClass}">${statusText}</span></td>
                                <td class="text-end pe-4">
                                    <a href="#" class="action-btn action-btn-view view-student" title="View Details" data-id="${student.student_id}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    document.getElementById('recent-applications').innerHTML = recentApplicationsHtml;
                    
                    // Add event listeners to the view buttons
                    document.querySelectorAll('.view-student').forEach(button => {
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            const studentId = this.getAttribute('data-id');
                            viewStudentDetails(studentId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading recent applications:', error);
                    document.getElementById('recent-applications').innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center">Error loading data. Please try again.</td>
                        </tr>
                    `;
                });
        }

        // Function to view student details
        function viewStudentDetails(studentId) {
            fetch(`/get_student/${studentId}`)
                .then(response => response.json())
                .then(student => {
                    // Populate modal with student data
                    document.getElementById('modal-student-id').textContent = student.student_id;
                    document.getElementById('modal-name').textContent = student.name || 'N/A';
                    document.getElementById('modal-course').textContent = student.course || 'N/A';
                    document.getElementById('modal-contact').textContent = student.contact || 'N/A';
                    document.getElementById('modal-guardian').textContent = student.guardian_name || 'N/A';
                    document.getElementById('modal-address').textContent = student.address || 'N/A';
                    
                    // Set profile picture and signature
                    const profilePicture = document.getElementById('modal-profile-picture');
                    const signature = document.getElementById('modal-signature');
                    
                    if (student.profile_picture) {
                        profilePicture.src = `/static/uploads/${student.profile_picture}`;
                    } else {
                        profilePicture.src = '/static/placeholder.jpg';
                    }
                    
                    if (student.signature) {
                        signature.src = `/static/uploads/${student.signature}`;
                    } else {
                        signature.src = '/static/placeholder.jpg';
                    }
                    
                    // Update status badge
                    const statusElement = document.getElementById('modal-status');
                    statusElement.className = 'badge';
                    let statusText = student.application_status ? 
                        student.application_status.charAt(0).toUpperCase() + student.application_status.slice(1) : 
                        'Unknown';
                    
                    switch(student.application_status) {
                        case 'pending':
                            statusElement.classList.add('badge-pending');
                            break;
                        case 'processing':
                            statusElement.classList.add('badge-processing');
                            break;
                        case 'done':
                            statusElement.classList.add('badge-done');
                            break;
                        case 'receive':
                            statusElement.classList.add('badge-receive');
                            statusText = 'Received';
                            break;
                        default:
                            statusElement.classList.add('badge-secondary');
                    }
                    
                    statusElement.textContent = statusText;
                    
                    // Update timeline based on status
                    updateTimeline(student.application_status);
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching student details:', error);
                    alert('Error loading student details. Please try again.');
                });
        }
        
        // Function to update timeline based on status
        function updateTimeline(status) {
            const timelineItems = document.querySelectorAll('.timeline-item');
            timelineItems.forEach(item => item.classList.remove('active', 'completed'));
            
            const now = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            switch(status) {
                case 'pending':
                    document.getElementById('timeline-pending').classList.add('active');
                    document.getElementById('timeline-pending-date').textContent = now;
                    break;
                case 'processing':
                    document.getElementById('timeline-pending').classList.add('completed');
                    document.getElementById('timeline-processing').classList.add('active');
                    document.getElementById('timeline-pending-date').textContent = now;
                    document.getElementById('timeline-processing-date').textContent = now;
                    break;
                case 'done':
                    document.getElementById('timeline-pending').classList.add('completed');
                    document.getElementById('timeline-processing').classList.add('completed');
                    document.getElementById('timeline-done').classList.add('active');
                    document.getElementById('timeline-pending-date').textContent = now;
                    document.getElementById('timeline-processing-date').textContent = now;
                    document.getElementById('timeline-done-date').textContent = now;
                    break;
                case 'receive':
                    document.getElementById('timeline-pending').classList.add('completed');
                    document.getElementById('timeline-processing').classList.add('completed');
                    document.getElementById('timeline-done').classList.add('completed');
                    document.getElementById('timeline-receive').classList.add('active');
                    document.getElementById('timeline-pending-date').textContent = now;
                    document.getElementById('timeline-processing-date').textContent = now;
                    document.getElementById('timeline-done-date').textContent = now;
                    document.getElementById('timeline-receive-date').textContent = now;
                    break;
            }
        }
        
        // Handle status update
        document.querySelectorAll('.status-update').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const newStatus = this.getAttribute('data-status');
                const studentId = document.getElementById('modal-student-id').textContent;
                
                // Send AJAX request to update status
                fetch(`/update_application_status/${studentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the status badge in the modal
                        const statusElement = document.getElementById('modal-status');
                        statusElement.className = 'badge';
                        let statusText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                        
                        switch(newStatus) {
                            case 'pending':
                                statusElement.classList.add('badge-pending');
                                break;
                            case 'processing':
                                statusElement.classList.add('badge-processing');
                                break;
                            case 'done':
                                statusElement.classList.add('badge-done');
                                break;
                            case 'receive':
                                statusElement.classList.add('badge-receive');
                                statusText = 'Received';
                                break;
                        }
                        
                        statusElement.textContent = statusText;
                        
                        // Update the timeline
                        updateTimeline(newStatus);
                        
                        // Refresh recent applications
                        loadRecentApplications();
                        
                        // Refresh the chart data
                        refreshDashboardData();
                        
                        // Show success message with modern toast
                        showToast(`Status updated successfully to ${statusText}`, 'success');
                    } else {
                        showToast('Error updating status: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error updating status. Please try again.', 'error');
                });
            });
        });
        
        // Refresh dashboard data
        function refreshDashboardData() {
            fetch('/admin_dashboard')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update counts
                    document.getElementById('total-students').textContent = doc.getElementById('total-students').textContent;
                    document.getElementById('pending-count').textContent = doc.getElementById('pending-count').textContent;
                    document.getElementById('processing-count').textContent = doc.getElementById('processing-count').textContent;
                    document.getElementById('done-count').textContent = doc.getElementById('done-count').textContent;
                    
                    // Update chart data
                    const pending = parseInt(doc.getElementById('pending-count').textContent);
                    const processing = parseInt(doc.getElementById('processing-count').textContent);
                    const done = parseInt(doc.getElementById('done-count').textContent);
                    const receive = parseInt(doc.getElementById('receive-count') ? doc.getElementById('receive-count').textContent : 0);
                    
                    statusChart.data.datasets[0].data = [pending, processing, done, receive];
                    statusChart.update();
                    
                    // Show success toast
                    showToast('Dashboard data refreshed successfully', 'success');
                })
                .catch(error => {
                    console.error('Error refreshing dashboard data:', error);
                    showToast('Error refreshing dashboard data', 'error');
                });
        }
        
        // Modern toast notification
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            // Set icon and background based on type
            let icon, bgClass;
            switch(type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    bgClass = 'bg-success';
                    break;
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    bgClass = 'bg-danger';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    bgClass = 'bg-warning';
                    break;
                default:
                    icon = 'fas fa-info-circle';
                    bgClass = 'bg-primary';
            }
            
            // Create toast element
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgClass} text-white">
                        <i class="${icon} me-2"></i>
                        <strong class="me-auto">Notification</strong>
                        <small>Just now</small>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Initialize and show toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            
            toast.show();
            
            // Remove toast after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
        
        // Refresh button click handler
        document.getElementById('refresh-data').addEventListener('click', function() {
            // Add spinner to button
            const originalContent = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Refreshing...';
            this.disabled = true;
            
            // Refresh data
            refreshDashboardData();
            loadRecentApplications();
            
            // Restore button after 1 second
            setTimeout(() => {
                this.innerHTML = originalContent;
                this.disabled = false;
            }, 1000);
        });
        
        // Handle table view button clicks
        document.querySelectorAll('.view-student').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const studentId = this.getAttribute('data-id');
                viewStudentDetails(studentId);
            });
        });
    });
</script>
{% endblock %}

